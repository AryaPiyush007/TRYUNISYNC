<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UniSync ‚Äî Marketplace</title>
<style>
:root{
  --bg:#f7fafc;
  --card:#ffffff;
  --muted:#6b7280;
  --accent1:#4f46e5;
  --accent2:#06b6d4;
  --radius:18px;
  --shadow:0 6px 20px rgba(16,24,40,0.08);
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(135deg,#eef2ff 0%, #fdf2f8 100%);color:#0f172a;}
.header{background:#fff;border-bottom:1px solid rgba(15,23,42,0.04);position:sticky;top:0;z-index:60;}
.container{max-width:1100px;margin:0 auto;padding:20px;}
.header-inner{display:flex;align-items:center;justify-content:space-between;height:64px;}
.brand{display:flex;align-items:center;gap:12px;text-decoration:none;color:inherit;}
.logo{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;
background:linear-gradient(90deg,#2563eb,#7c3aed);}
.brand-title{font-size:20px;font-weight:800;background:linear-gradient(90deg,#2563eb,#7c3aed);-webkit-background-clip:text;background-clip:text;color:transparent}
.layout{display:grid;grid-template-columns:260px 1fr;gap:24px;max-width:1100px;margin:18px auto;padding:0 20px 80px;}
.sidebar{background:var(--card);border-radius:16px;padding:16px;box-shadow:var(--shadow);position:sticky;top:88px;height:fit-content;}
.nav-button{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:none;background:transparent;width:100%;cursor:pointer;font-weight:600;color:#0f172a;text-decoration:none;}
.nav-button:hover{background:linear-gradient(90deg,#f8fafc,#f6f5ff);}
.nav-button.active{background:linear-gradient(90deg,rgba(79,70,229,0.08),rgba(124,58,237,0.06));}
.btn{padding:9px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;}
.btn.primary{background:linear-gradient(90deg,#22c55e,#16a34a);color:#fff;}
.btn.ghost{border:1px solid rgba(15,23,42,0.06);background:transparent;}
.card{background:var(--card);border-radius:14px;padding:18px;box-shadow:var(--shadow);}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
@media(max-width:900px){.layout{grid-template-columns:1fr;padding:0 12px}.grid-3{grid-template-columns:1fr}.sidebar{position:relative;top:auto}}
</style>
</head>
<body>
<header class="header">
<div class="container header-inner">
<a href="index.html" class="brand"><div class="logo">U</div><div class="brand-title">UniSync</div></a>
<div style="display:flex;align-items:center;gap:14px">
<div style="font-size:20px">üîî</div><div style="width:36px;height:36px;border-radius:999px;background:#f1f5f9;display:flex;align-items:center;justify-content:center">üë§</div>
<div style="font-size:14px;color:#6b7280">Piyush</div>
</div>
</div>
</header>
<div class="layout">
<aside class="sidebar">
<div style="font-size:12px;color:#6b7280;margin-bottom:10px">Explore</div>
<nav>
<a class="nav-button" href="index.html">üè† Home</a>
<a class="nav-button" href="notes.html">üìù Notes Sharing</a>
<a class="nav-button active" href="marketplace.html">üõí Marketplace</a>
<a class="nav-button" href="events.html">üìÖ Events</a>
<a class="nav-button" href="groups.html">üë• Study Groups</a>
<a class="nav-button" href="forum.html">üí¨ Q&amp;A Forum</a>
<a class="nav-button" href="messages.html">üíå Messages</a>
<a class="nav-button" href="dashboard.html">üìä Dashboard</a>
</nav>
<div style="margin-top:14px;border-top:1px solid rgba(15,23,42,0.04);padding-top:12px">
<div style="font-size:11px;color:#6b7280">Quick actions</div>
<div style="display:flex;gap:8px;margin-top:8px">
<button class="btn primary" onclick="window.location='#post'">Post Item</button>
<button class="btn ghost" onclick="window.location='index.html'">Back to Home</button>
</div>
</div>
</aside>

<section>
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<div><h2 style="margin:0;font-size:24px">Marketplace</h2>
<div style="font-size:13px;color:#6b7280">Buy and sell items within your campus community.</div></div>
</div>

<div class="grid-3">
<div class="card"><div style="height:140px;background:#f1f5f9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px">üì¶</div>
<div style="margin-top:10px;font-weight:700">Used TI-84 Calculator</div>
<div style="font-size:13px;color:#6b7280">Karan ‚Ä¢ BMS CSE</div>
<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
<div style="font-weight:700">‚Çπ1,500</div><button class="btn ghost">Message</button>
</div></div>

<div class="card"><div style="height:140px;background:#f1f5f9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px">üìö</div>
<div style="margin-top:10px;font-weight:700">Textbook: Algorithms (CLRS)</div>
<div style="font-size:13px;color:#6b7280">Maya ‚Ä¢ BMS ECE</div>
<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
<div style="font-weight:700">‚Çπ600</div><button class="btn ghost">Message</button>
</div></div>

<div class="card"><div style="height:140px;background:#f1f5f9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px">üéß</div>
<div style="margin-top:10px;font-weight:700">Wireless Headphones</div>
<div style="font-size:13px;color:#6b7280">Anjali ‚Ä¢ BMS ME</div>
<div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
<div style="font-weight:700">‚Çπ1,200</div><button class="btn ghost">Message</button>
</div></div>
</div>

<div id="post" class="card" style="margin-top:20px">
<h3 style="margin:0 0 10px 0">Post a New Item</h3>
<form onsubmit="event.preventDefault();alert('Item posted successfully (mock)!')">
<div style="display:flex;flex-wrap:wrap;gap:10px">
<input required placeholder="Item Name" style="flex:1;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)" />
<input required placeholder="Price (‚Çπ)" style="width:120px;padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06)" />
<input type="file" style="padding:6px" />
<button type="submit" class="btn primary">Post</button>
</div>
</form>
</div>


</section>
</div>
<script>
    // API Configuration
    const API_BASE_URL = 'http://localhost:3000/api';

    // Authentication State
    let currentUser = null;
    let authToken = localStorage.getItem('token');

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
      loadMarketplaceItems();
      setupEventListeners();
    });

    // Check authentication
    async function checkAuth() {
      if (authToken) {
        try {
          const response = await fetch(`${API_BASE_URL}/auth/profile`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });

          if (response.ok) {
            const data = await response.json();
            currentUser = data.data.user;
            updateUIForAuthenticatedUser();
          } else {
            logout();
          }
        } catch (error) {
          console.error('Auth check failed:', error);
          logout();
        }
      }
    }

    // Update UI for authenticated user
    function updateUIForAuthenticatedUser() {
      if (currentUser) {
        const userDisplay = document.querySelector('.header-right div:last-child');
        if (userDisplay) {
          userDisplay.textContent = currentUser.username;
        }
      }
    }

    // Load marketplace items
    async function loadMarketplaceItems() {
      try {
        const response = await fetch(`${API_BASE_URL}/marketplace`);

        if (response.ok) {
          const data = await response.json();
          displayMarketplaceItems(data.data.marketplace_items);
        } else {
          console.error('Failed to load marketplace items');
        }
      } catch (error) {
        console.error('Error loading marketplace items:', error);
        // Keep demo data if API fails
      }
    }

    // Display marketplace items
    function displayMarketplaceItems(items) {
      const grid = document.querySelector('.grid-3');
      if (!grid) return;

      if (items.length === 0) {
        grid.innerHTML = '<div class="card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">No marketplace items available</div>';
        return;
      }

      grid.innerHTML = items.map(item => `
        <div class="card">
          ${item.image_urls && item.image_urls.length > 0 ?
            `<img src="${item.image_urls[0]}" alt="${item.title}" style="width:100%;height:140px;object-fit:cover;border-radius:10px;">` :
            `<div style="height:140px;background:#f1f5f9;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:40px">üì¶</div>`
          }
          <div style="margin-top:10px;font-weight:700">${item.title}</div>
          <div style="font-size:13px;color:#6b7280">${item.seller?.username || 'Unknown'} ‚Ä¢ ${item.category || 'General'}</div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">‚Çπ${item.price}</div>
            <button class="btn ghost" onclick="contactSeller('${item.seller_id}')">Message</button>
          </div>
          ${item.condition ? `<div style="font-size:12px;color:#9ca3af;margin-top:4px;">Condition: ${item.condition.replace('_', ' ')}</div>` : ''}
        </div>
      `).join('');
    }

    // Setup event listeners
    function setupEventListeners() {
      const postForm = document.querySelector('#post form');
      if (postForm) {
        postForm.addEventListener('submit', handlePostItem);
      }
    }

    // Handle posting new item
    async function handlePostItem(e) {
      e.preventDefault();

      if (!currentUser) {
        alert('Please login to post items');
        return;
      }

      const formData = new FormData();
      const title = e.target.querySelector('input[placeholder="Item Name"]').value;
      const price = e.target.querySelector('input[placeholder="Price (‚Çπ)"]').value;
      const file = e.target.querySelector('input[type="file"]').files[0];

      if (!title || !price) {
        alert('Please fill all required fields');
        return;
      }

      formData.append('title', title);
      formData.append('description', `${title} - Posted on UniSync marketplace`);
      formData.append('price', price);
      formData.append('category', 'general');
      formData.append('condition', 'good');

      if (file) {
        formData.append('images', file);
      }

      try {
        const response = await fetch(`${API_BASE_URL}/marketplace`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`
          },
          body: formData
        });

        if (response.ok) {
          alert('Item posted successfully!');
          e.target.reset();
          loadMarketplaceItems(); // Refresh the list
        } else {
          const error = await response.json();
          alert('Failed to post item: ' + error.error);
        }
      } catch (error) {
        console.error('Post error:', error);
        alert('Failed to post item. Please try again.');
      }
    }

    // Contact seller
    function contactSeller(sellerId) {
      if (!currentUser) {
        alert('Please login to contact sellers');
        return;
      }

      // For now, just show an alert. In a real app, this would open a chat modal
      alert('Chat feature coming soon! Seller ID: ' + sellerId);
    }

    function logout() {
      localStorage.removeItem('token');
      authToken = null;
      currentUser = null;
      window.location.reload();
    }

    window.contactSeller = contactSeller;
</script>
</body>
</html>
